<!DOCTYPE html>
<html>
<head>
	
	<script type="text/javascript" src="ExcelPlus/sheetjs.all.min.js"></script>
	<script type="text/javascript" src="ExcelPlus/excelplus-2.2.min.js"></script>

	<meta charset="utf-8">

	<link rel="stylesheet" href="http://s3.amazonaws.com/codecademy-content/courses/ltp/css/bootstrap.css">
	<link rel="stylesheet" href="main.css">
	<link rel="stylesheet" type="text/css" href="print.css" media="print"> 
	<link rel="stylesheet" href="drag-css.css" type="text/css" media="screen" />
	<meta name="viewport" content="width=device-width">

	<script type="text/javascript" src="sorting_functions.js"></script>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.5.0.min.js"></script>

	<!-- Drag and drop library. Credits to http://www.redips.net/javascript/drag-and-drop-table-content/ -->
	<script type="text/javascript" src="redips-drag-min.js"></script> 
	<script type="text/javascript" src="header.js"></script>
</head>
<body onload="REDIPS.drag.init(); REDIPS.drag.dropMode = 'single';">
	<!-- Title -->
	<h1>Lineup Generator</h1>
	
	<!--Prompt-->
	<div id="step1">
		<h3>1. Upload your .xlsx spreadsheet here.</h3>

		<!-- "Choose File" button -->
		<object id="file-object"></object>
	</div>


	

	<!-- Buttons for choosing the day that the lineup is for -->
	<div id="step2" style="display:none";>
		<h4>Info read from spreadsheet:</h4>
		<div id="result"></div>
		<br>

		<h3>2. Choose the day that you are making a lineup for.</h3>
		<button onclick="friday();">Friday</button>
		<button onclick="saturday();">Saturday</button>
		<button onclick="sunday();">Sunday</button>
	</div>
	


	<div id="step3" style="display:none">
		<div id="unknown"></div>	
		<br>		
	</div>	

	<div id ="balance">Weight is: Balanced</div>
	<button id = "fillButton" onclick="autofill()" style="display:none;">Autofill</button>









	<div id="redips-drag" style="width:100%; ">
		
		<!-- Roster table -->
		<div style="float:left;">
			<h2 id="rosterTitle">Roster from spreadsheet will load here.</h2>
			<table id="roster">
				<colgroup>
					<col width="100"/>
				</colgroup>

				<tbody id="rosterBody"></tbody>
			</table>
		</div>


		<!-- Boat table -->
		<div style="float:left; padding-left:100px;">
			<h1>Boat</h1>
			<table id="boat">
				<colgroup>
					<col width="100"/>
					<col width="100"/>
				</colgroup>

				<tbody id="boatBody">
					<tr>
						<td class="A"></td>
						<td></td>
					</tr>
					<tr>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td></td>
						<td></td>
					</tr>
				</tbody>
			</table>
		</div>

		<!-- Full roster table -->
		<div style="float:left; padding-left:100px;">
			<h1>Full Roster</h1>
			<table id="fullRoster">
				<colgroup>
					<col width="100"/>
				</colgroup>

				<tbody id="fullRosterBody"></tbody>
			</table>
		</div>


	</div>

<!--Credits to http://aymkdn.github.io/ExcelPlus/ for the ExcelPlus library -->
<script>
	Parse.initialize("Ir9YzTyozWr3zBMzUq8MsOs9toJyWO1E33jGjFni", "NEpob0acvjC8kZo8y8LxX4QQsyPewCmZ4fOfjSY0");
	var currentuser = Parse.User.current();

	var fridayOutput = "Friday Paddlers:\n";
	var fridayArray = [];
	var saturdayOutput = "Saturday Paddlers:\n";
	var saturdayArray = [];
	var sundayOutput = "Sunday Paddlers:\n"
	var sundayArray = [];
	var leftArray =  [0,0,0,0,0,0,0,0,0,0];
	var rightArray = [0,0,0,0,0,0,0,0,0,0];
	var Paddler = Parse.Object.extend("Paddler");
	var leftWeight = 0;
	var rightWeight = 0;
	var balanceWeight = 0;

	if(currentuser){

		

		// Fills in the full roster;
		var fullQuery = new Parse.Query(Paddler);	
				fullQuery.equalTo("Owner", Parse.User.current().getUsername());
				fullQuery.find({
					success: function(results) {					
						for(var i = 0; i < results.length; i++){
							var table = document.getElementById("fullRosterBody");
							var row = table.insertRow(-1);
							var cell = row.insertCell(0).innerHTML = '<div id="'+ results[i].id + '"class="redips-drag" style="border-style: solid; cursor: move;">' + results[i].get("Name") + '</div>';
							
						}
						REDIPS.drag.init();
					},
					error: function(error) {
						alert("error");
					}
				});



		var ep = new ExcelPlus();
		ep.openLocal({
			"flashPath":"/ExcelPlus/sfwobject/",
			"labelButton":"Open an Excel file"
		},function() {
			// format of a = [row][column]
			var a = ep.selectSheet(1).readAll();
			


			var nameCol = 0;
			for (var row = 0; row < a.length; row++) {
				for(var col = 0; col < a[row].length; col++){
					if(a[row][col] == "Your Name"){
						nameCol = col;
					}


					if(a[row][col] == "Will you be attending Friday's practice?"){
						
						var fridayRow = 1;
						
						for(var fridayRow = 1; fridayRow < a.length; fridayRow++){
							if(a[fridayRow][col] == "Yes!" || a[fridayRow][col] == "Yes, and I can drive."){
								fridayOutput += (a[fridayRow][nameCol] + ", ");
								fridayArray.push(a[fridayRow][nameCol]);
							}
						}

						// The slice removes the comma and space after the last name
						document.getElementById("result").innerHTML += fridayOutput.slice(0,fridayOutput.length-2) + "<br>";

					}
					else if(a[row][col] == "Will you be attending Saturday's practice?"){
						for(var saturdayRow = 1; saturdayRow < a.length; saturdayRow++){
							if(a[saturdayRow][col] == "Yes!" || a[saturdayRow][col] == "Yes, and I can drive."){
								saturdayOutput += (a[saturdayRow][nameCol] + ", ");
								saturdayArray.push(a[saturdayRow][nameCol]);
							}
						}

						// The slice removes the comma and space after the last name
						document.getElementById("result").innerHTML += saturdayOutput.slice(0,saturdayOutput.length-2) + "<br>";

					}
					else if(a[row][col] == "Will you be attending Sunday's practice?"){
						for(var sundayRow = 1; sundayRow < a.length; sundayRow++){
							if(a[sundayRow][col] == "Yes!" || a[sundayRow][col] == "Yes, and I can drive."){
								sundayOutput += (a[sundayRow][nameCol] + ", ");
								sundayArray.push(a[sundayRow][nameCol]);
							}
						}

						// The slice removes the comma and space after the last name
						document.getElementById("result").innerHTML += sundayOutput.slice(0,sundayOutput.length-2) + "<br>";

					}

				}
			}

			// Shows step 2 and hides step 1 material
			document.getElementById("step2").style.display = "block";
			document.getElementById("step1").style.display = "none";	
			document.getElementById("file-object").style.display = "none";
		});


	}


		// Friday roster filler
		function friday() {

			// Clears roster if day is switched
			document.getElementById("rosterBody").innerHTML = "";
			

			var query = new Parse.Query(Paddler);	
			
			// Copies friday array into tmp
			var tmp = [];
			for(var a = 0; a < fridayArray.length; a++){
				tmp[a] = fridayArray[a];
			}

			query.containedIn("Name", tmp);
			query.equalTo("Owner", Parse.User.current().getUsername());
			query.find({
				success: function(results) {
					document.getElementById("rosterTitle").innerHTML = "Friday Roster";
					for(var i = 0; i < results.length; i++){
						tmp.splice(tmp.indexOf(results[i].get("Name")), 1);

						var table = document.getElementById("rosterBody");
						var row = table.insertRow(-1);
						var cell = row.insertCell(0).innerHTML = '<div id="' + results[i].id + '"class="redips-drag" style="border-style: solid; cursor: move;">' + results[i].get("Name") + '</div>';
						
					}
					

					document.getElementById("unknown").innerHTML = "<br><p style='background-color:#FF6666'>Paddlers not found in team roster: " + tmp.toString() + "</p>";
					document.getElementById("step2").style.display = "none";
					document.getElementById("step3").style.display = "block";
					document.getElementById("fillButton").style.display = "block";
					REDIPS.drag.init();
				},
				error: function(error) {
					alert("error");
				}
			});

		}

				// Friday roster filler
		function saturday() {
			// Clears roster if day is switched
			document.getElementById("rosterBody").innerHTML = "";

			var query = new Parse.Query(Paddler);	
			
			// Copies friday array into tmp
			var tmp = [];
			for(var a = 0; a < saturdayArray.length; a++){
				tmp[a] = saturdayArray[a];
			}

			query.containedIn("Name", tmp);
			query.equalTo("Owner", Parse.User.current().getUsername());
			query.find({
				success: function(results) {
					document.getElementById("rosterTitle").innerHTML = "Saturday Roster";
					for(var i = 0; i < results.length; i++){
						tmp.splice(tmp.indexOf(results[i].get("Name")), 1);

						var table = document.getElementById("rosterBody");
						var row = table.insertRow(-1);
						var cell = row.insertCell(0).innerHTML = '<div id="' + results[i].id + '" class="redips-drag" style="border-style: solid; cursor: move;">' + results[i].get("Name") + '</div>';
						
					}
					document.getElementById("unknown").innerHTML = "<br><p style='background-color:#FF6666'>Paddlers not found in team roster: " + tmp.toString() + "</p>";
					document.getElementById("step2").style.display = "none";
					document.getElementById("step3").style.display = "block";
					document.getElementById("fillButton").style.display = "block";
					REDIPS.drag.init();

					
				},
				error: function(error) {
					alert("error");
				}
			});
		}

				// Friday roster filler
		function sunday() {
			// Clears roster if day is switched
			document.getElementById("rosterBody").innerHTML = "";

			var query = new Parse.Query(Paddler);	
			
			// Copies friday array into tmp
			var tmp = [];
			for(var a = 0; a < sundayArray.length; a++){
				tmp[a] = sundayArray[a];
			}

			query.containedIn("Name", tmp);
			query.equalTo("Owner", Parse.User.current().getUsername());
			query.find({
				success: function(results) {
					document.getElementById("rosterTitle").innerHTML = "Sunday Roster";
					for(var i = 0; i < results.length; i++){
						tmp.splice(tmp.indexOf(results[i].get("Name")), 1);

						var table = document.getElementById("rosterBody");
						var row = table.insertRow(-1);
						var cell = row.insertCell(0).innerHTML = '<div id="' + results[i].id + '" class="redips-drag" style="border-style: solid; cursor: move;">' + results[i].get("Name") + '</div>';
						
					}
					document.getElementById("unknown").innerHTML = "<br><p style='background-color:#FF6666'>Paddlers not found in team roster: " + tmp.toString() + "</p>";
					document.getElementById("step2").style.display = "none";
					document.getElementById("step3").style.display = "block";
					document.getElementById("fillButton").style.display = "block";
					REDIPS.drag.init();

					
				},
				error: function(error) {
					alert("error");
				}
			});
		}

	// Handles changes to people in the boat
	REDIPS.drag.event.dropped = function(target) {

		// Id of the dragged person
		//alert(REDIPS.drag.obj.getAttribute('id'));

		// Location of the target cell / source cell
		var position = REDIPS.drag.getPosition();

		//alert("Table: " + position[0] + ", Row: " + position[1] + ", Column: " + position[2]);
		//alert("Source Table: " + position[3] + ", Source Row: " + position[4] + ", Source Column: " + position[5]);

		var weightQuery = new Parse.Query(Paddler);
				
		weightQuery.equalTo("objectId", REDIPS.drag.obj.getAttribute('id'));
		weightQuery.find({
			success: function(results) {

				var weight = results[0].get("Weight");

				// If dropped into boat
				if(position[0] == 1){		
					// If person was dragged from a different table
					if(position[3] != 1){
						
						// Adds right or left weight depending on drop position
						if(position[2] == 0){
							leftArray[position[1]] = weight;
							leftWeight += weight;
						}
						// Otherwise dropped into right side
						else{
							rightArray[position[1]] = weight;
							rightWeight += weight;
						}
					}	
					// If person was dragged from a different column in the boat
					else if(position[2] != position[5]){

						if(position[2] == 0){
							leftArray[position[1]] = weight;
							rightArray[position[4]] = 0;
							leftWeight += weight;
							rightWeight -= weight;
						}
						
						else{
							rightArray[position[1]] = weight;
							leftArray[position[4]] = 0;
							rightWeight += weight;
							leftWeight -= weight; 
						}
					}
					else if(position[2] == position[5]){
						// Moved to same column
						if(position[2] == 0){
							leftArray[position[1]] = weight;
							leftArray[position[4]] = 0;
						}
						else{
							rightArray[position[1]] = weight;
							rightArray[position[4]] = 0;
						}

					}
				}
				else {
					// If source table was the boat
					if(position[3] == 1){
						// Remove weight of that person
						if(position[5] == 0){
							leftWeight -= weight;
							leftArray[position[1]] = 0;
						}
						else{
							rightWeight -= weight;
							rightArray[position[1]] = 0;
						}
					}
				}

				

				getBalance();

			//	alert(leftArray.toString());
			//	alert(rightArray.toString());
			},
			error: function(error) {

			}
		});


	}
		
		function getBalance(){
			balanceWeight = leftWeight - rightWeight;
				if(balanceWeight > 0){
					document.getElementById("balance").innerHTML = "Weight is: " + (balanceWeight) + " lbs left-heavy";
				}
				else if(balanceWeight < 0){
					document.getElementById("balance").innerHTML = "Weight is: " + (-balanceWeight) + " lbs right-heavy";
				}
				else{
					document.getElementById("balance").innerHTML = "Weight is: Balanced";	
				}
		}


	function autofill(){
		var rTable = document.getElementById("rosterBody");
		var bTable = document.getElementById("boatBody");
		var nameArray = [];


		for(var i = 0; i < rTable.rows.length; i++){
			// Slice removes a newline at the end of the name
			if(rTable.rows[i].cells[0].innerText.slice(0, -1) != ""){
				nameArray.push(rTable.rows[i].cells[0].innerText.slice(0, -1));
			}
		}

		
		var query = new Parse.Query(Paddler);

		query.containedIn("Name", nameArray);
		query.ascending("Weight");
		query.find({
			success: function (results){
				// results is the list of paddlers that were in the roster
				
				
				// Temporarily set to 10, may change this to allow for both 20man and 10man boats
				var boxRows = 3;
				var engineRows = 7;
				var rocketRows = 10;
				var boatRows = 10;
				// This loop finds box rows that have only one person 
				// sitting in them already and fills 
				// the empty spot with someone of similar weight
				for(var i = 0; i < boatRows; i++){
					// For each row, find out if anyone is already filled in. 
					// If so, check if they have a partner, and if not, find someone with the
					// closest weight, and put them there
					var row = document.getElementById("boatBody").rows[i].cells;


					//document.getElementById("boatBody").rows[i].cells[0].innerHTML = '<div id="' + results[i].id + '" class="redips-drag" style="border-style: solid; cursor: move;">' + results[i].get("Name") + '</div>';

					// If left side is empty
					if(row[0].innerHTML == ""){
						// If right side is not empty
						if(row[1].innerHTML != ""){
							// Match weight of other person in row
							// The default weight difference is 30.
							var closest = 200;
							var index = -1;
							for(var j = 0; j < results.length; j++){
								if(Math.abs(rightArray[i] - results[j].get("Weight")) < closest){
									if(results[j].get("Side") == "Left"){
										closest = Math.abs(rightArray[i] - results[j].get("Weight"));
										index = j;
									}
								}
							}
							document.getElementById("boatBody").rows[i].cells[0].innerHTML = '<div id="' + results[index].id + '" class="redips-drag" style="border-style: solid; cursor: move;">' + results[index].get("Name") + '</div>';

							leftWeight += results[index].get("Weight");
							leftArray[i] = results[index].get("Weight");
						
							results.splice(index, 1);
						
							getBalance();
// Entire row is empty
// Remove names from roster as they fill into the boat
// Balance front and back / 
// Try to distribute weight, heavy people in the middle, etc.
						}
					}
					else{
						if(row[1].innerHTML == ""){
							var closest = 200;
							var index = -1;
							for(var j = 0; j < results.length; j++){
								if(Math.abs(leftArray[i] - results[j].get("Weight")) < closest){
									if(results[j].get("Side") == "Right"){
										closest = Math.abs(leftArray[i] - results[j].get("Weight"));
										index = j;
									}
								}
							}
							document.getElementById("boatBody").rows[i].cells[1].innerHTML = '<div id="' + results[index].id + '" class="redips-drag" style="border-style: solid; cursor: move;">' + results[index].get("Name") + '</div>';

							rightWeight += results[index].get("Weight");
							rightArray[i] = results[index].get("Weight");
						
							results.splice(index, 1);
							// Match weight of other person in row
							getBalance();	
						}
					}
						
				}

				// Fills in the rest of the empty rows
				for(var j = 0; j < boatRows; j++){

					var row = document.getElementById("boatBody").rows[j].cells;
					
					if(row[0].innerHTML == "" && row[1].innerHTML == ""){
						if(j < boxRows){
							var boxL = [];
							var boxR = [];
							for(var k = 0; k < results.length; k++){
								if(results[k].get("Section") == "Box"){
									if(results[k].get("Side") == "Left"){
										alert("Putting " +)
										boxL.push(results[k]);
									}
									else{
										boxR.push(results[k]);
									}
								
								}
							}

							var closest = 200;
							var indexL = -1;
							var indexR = -1;
							for(var k = 0; k < boxL.length; k++){
								for(var l = 0; l < boxR.length; l++){
									if(Math.abs(boxL[k].get("Weight") - boxR[l].get("Weight")) < closest){
										closest = Math.abs(boxL[k].get("Weight") - boxR[l].get("Weight"));
										indexL = k;
										indexR = l;
									}
								}
							}

							if(indexL != -1){
								row[0].innerHTML = '<div id="' + results[indexL].id + '" class="redips-drag" style="border-style: solid; cursor: move;">' + results[indexL].get("Name") + '</div>';
								results.splice(indexL, 1);
								if(indexL < indexR){
									indexR--;
								}
							}

							if(indexR != -1){
								row[1].innerHTML = '<div id="' + results[indexR].id + '" class="redips-drag" style="border-style: solid; cursor: move;">' + results[indexR].get("Name") + '</div>';	
								results.splice(indexR, 1);
							}
						}
					}
				}




				REDIPS.drag.init();
			},
			error: function (error){
				alert("Error");
			}

		});
	}
</script>



</body>

</html>